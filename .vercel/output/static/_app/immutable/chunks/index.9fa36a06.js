var k=Object.defineProperty;var N=(i,t,s)=>t in i?k(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s;var n=(i,t,s)=>(N(i,typeof t!="symbol"?t+"":t,s),s);var c=(i=>(i.IDLE="I",i.STARTING="A",i.RUNNING=" ",i.STOPPED="S",i.LEFT_HAND="L",i.RIGHT_HAND="R",i.BOTH_HANDS="C",i.INVALID="X",i))(c||{});function H(i){return"IA SLRC".indexOf(String.fromCharCode(i))!==-1}function r(i){return"0123456789".indexOf(String.fromCharCode(i))!==-1}function R(i,t){return i===t.map(s=>Number(String.fromCharCode(s))).reduce((s,e)=>s+e)+64}class u{constructor(t,s,e,o){n(this,"isValid");n(this,"status");n(this,"timeInMilliseconds");n(this,"stringDigits");this.isValid=t,this.status=s||"X",this.stringDigits=e||[],this.timeInMilliseconds=o||0}get timeAsString(){return this.stringDigits.slice(0,1)+":"+this.stringDigits.slice(1,3).join("")+"."+this.stringDigits.slice(3).join("")}get isLeftHandDown(){return this.status==="L"||this.status==="C"||this.status==="A"}get isRightHandDown(){return this.status==="R"||this.status==="C"||this.status==="A"}get areBothHandsDown(){return this.status==="C"||this.status==="A"}}class P extends u{constructor(){super(!1)}}class g extends u{static isValid(t){return t.length===9&&H(t[0])&&r(t[1])&&r(t[2])&&r(t[3])&&r(t[4])&&r(t[5])&&R(t[6],t.slice(1,6))&&t[7]===10&&t[8]===13}constructor(t){if(g.isValid(t)){const s=String.fromCharCode(t[0]),e=t.slice(1,6).map(f=>String.fromCharCode(f)),o=Number(e[0]),h=Number(e.slice(1,3).join("")),l=Number(e.slice(3).join("")+"0"),d=o*6e4+h*1e3+l;super(!0,s,e,d)}else super(!1)}}class m extends u{static isValid(t){return t.length===10&&H(t[0])&&r(t[1])&&r(t[2])&&r(t[3])&&r(t[4])&&r(t[5])&&r(t[6])&&R(t[7],t.slice(1,7))&&t[8]===10&&t[9]===13}constructor(t){if(m.isValid(t)){const s=String.fromCharCode(t[0]),e=t.slice(1,7).map(f=>String.fromCharCode(f)),o=Number(e[0]),h=Number(e.slice(1,3).join("")),l=Number(e.slice(3).join("")),d=o*6e4+h*1e3+l;super(!0,s,e,d)}else super(!1)}}class D{constructor(t,s){n(this,"ticksPerBit");n(this,"callback");this.ticksPerBit=t/1200,this.callback=s}decode(t){let s=[];for(const l of t)s.push(l<=0?1:0);const e=this.findBeginningOfSignal(s),o=C(s.slice(e));s=this.getBitsFromRunLengthEncodedSignal(o);const h=w(s.slice(1));h.isValid&&this.callback(h)}findBeginningOfSignal(t){let s=0,e=!1;for(let o=0;o<t.length;o++)if(t[o]===1)s++,s>9*this.ticksPerBit&&(e=!0);else if(s=0,e)return o}getBitsFromRunLengthEncodedSignal(t){const s=t.map(e=>Array(Math.round(e.length/this.ticksPerBit)).fill(e.bit));return[].concat(...s)}}function C(i){let t=-1;const s=[];for(const e of i)t!==e?(s.push({bit:e,length:1}),t=e):s[s.length-1].length++;return s}function w(i){const t=[];for(let e=0;e<=9;e++)t.push(S(i,e*10));let s=new m(t);return s.isValid||(s=new g(t.slice(0,-1))),s}function S(i,t){let s=0;for(let e=0;e<8;e++)s+=i[t+e]<<e;return s}const I=URL.createObjectURL(new Blob(["(",function(){class i extends AudioWorkletProcessor{constructor(){super();n(this,"bufferSize",10240);n(this,"chunkBuffer",new Float32Array(this.bufferSize));n(this,"offset",0)}process(e){const h=e[0][0];return this.chunkBuffer.set(h,this.offset),this.offset+=h.length,this.offset>=this.bufferSize&&(this.port.postMessage(this.chunkBuffer),this.chunkBuffer=new Float32Array(this.bufferSize),this.offset=0),!0}}registerProcessor("stackmat-processor",i)}.toString(),")()"],{type:"application/javascript"}));class b{constructor(t){n(this,"callback");n(this,"stream");n(this,"context");n(this,"source");n(this,"workletNode");this.callback=t}start(){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1}}).then(t=>{this.stream=t,this.context=new AudioContext,this.source=this.context.createMediaStreamSource(this.stream);const s=new D(this.context.sampleRate,this.callback);this.context.audioWorklet.addModule(I).then(()=>{this.context&&this.source&&(this.workletNode=new AudioWorkletNode(this.context,"stackmat-processor",{numberOfInputs:1,numberOfOutputs:1}),this.workletNode.port.onmessage=e=>{s.decode(e.data)},this.source.connect(this.workletNode),this.workletNode.connect(this.source.context.destination))})}).catch(t=>{console.error(t)})}stop(){this.context&&this.source&&this.workletNode&&(this.source.disconnect(this.workletNode),this.workletNode.disconnect(this.context.destination),this.workletNode=void 0,this.source=void 0,this.context.close().finally(()=>{this.context=void 0})),this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=void 0)}}const A=i=>i,B=A(["packetReceived","timerConnected","timerDisconnected","started","stopped","reset","ready","unready","starting","leftHandDown","leftHandUp","rightHandDown","rightHandUp"]),a=i=>typeof i=="string"&&B.includes(i);class M{constructor(){n(this,"lastPacket");n(this,"lastPacketRunning",!1);n(this,"lastPacketReset",!1);n(this,"handlers",new Map);n(this,"connected",!1);n(this,"lastPacketReceived",0);n(this,"connectionTimout",1e3);setInterval(()=>{this.connected&&this.lastPacketReceived+this.connectionTimout<Date.now()?(this.connected=!1,this.fire("timerDisconnected",this.lastPacket||new P)):!this.connected&&this.lastPacketReceived+this.connectionTimout>Date.now()&&(this.connected=!0,this.fire("timerConnected",this.lastPacket||new P))},100,this)}on(t,s){if(a(t)){const e=this.handlers.get(t)||[];e.push(s),this.handlers.set(t,e)}}off(t){t&&a(t)&&this.handlers.has(t)?this.handlers.delete(t):t||this.handlers.clear()}receivePacket(t){this.lastPacketReceived=Date.now(),this.fire("packetReceived",t),this.lastPacket&&(this.lastPacket.isLeftHandDown&&!t.isLeftHandDown?this.fire("leftHandUp",t):!this.lastPacket.isLeftHandDown&&t.isLeftHandDown&&this.fire("leftHandDown",t),this.lastPacket.isRightHandDown&&!t.isRightHandDown?this.fire("rightHandUp",t):!this.lastPacket.isRightHandDown&&t.isRightHandDown&&this.fire("rightHandDown",t),!this.lastPacket.areBothHandsDown&&t.status===c.BOTH_HANDS&&this.lastPacket.timeInMilliseconds===0&&this.fire("ready",t),this.lastPacket.status===c.BOTH_HANDS&&!t.areBothHandsDown&&t.status!==c.RUNNING&&t.timeInMilliseconds===0&&this.fire("unready",t),this.lastPacket.status===c.BOTH_HANDS&&t.status===c.STARTING&&this.fire("starting",t),!this.lastPacketRunning&&(t.status===c.RUNNING||this.lastPacket.timeInMilliseconds===0&&t.timeInMilliseconds>0)&&(this.lastPacketRunning=!0,this.lastPacketReset=!1,this.fire("started",t)),this.lastPacketRunning&&(t.status===c.STOPPED||t.status===c.BOTH_HANDS||this.lastPacket.timeInMilliseconds===t.timeInMilliseconds&&t.timeInMilliseconds>0)&&(this.lastPacketRunning=!1,this.lastPacketReset=!1,!this.lastPacket.isLeftHandDown&&!t.isLeftHandDown&&this.fire("leftHandDown",t),!this.lastPacket.isRightHandDown&&!t.isRightHandDown&&this.fire("rightHandDown",t),this.fire("stopped",t),!this.lastPacket.isLeftHandDown&&!t.isLeftHandDown&&this.fire("leftHandUp",t),!this.lastPacket.isRightHandDown&&!t.isRightHandDown&&this.fire("rightHandUp",t)),!this.lastPacketReset&&t.status===c.IDLE&&(this.lastPacketRunning=!1,this.lastPacketReset=!0,this.fire("reset",t))),this.lastPacket=t}fire(t,s){for(const e of this.handlers.get(t)||[])e(s)}}class v{constructor(){n(this,"eventManager",new M);n(this,"audioProcessor")}on(t,s){return a(t)?(this.eventManager.on(t,s),!0):!1}off(t){return t&&!a(t)?!1:(this.eventManager.off(t),!0)}start(){this.audioProcessor&&this.stop(),this.audioProcessor=new b(t=>this.eventManager.receivePacket(t)),this.audioProcessor.start()}stop(){this.audioProcessor&&(this.audioProcessor.stop(),this.audioProcessor=void 0)}}export{c as PacketStatus,v as Stackmat,v as default};
